<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø³Ú©Ù†Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§Ø³Ù†Ø§Ø¯</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f8f9fa; padding: 20px; text-align: center; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-family: inherit; font-size: 16px; margin: 5px; }
        .btn:hover { opacity: 0.9; }
        .grid { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin-top: 20px; }
        .card { background: white; padding: 10px; border: 1px solid #ddd; border-radius: 10px; width: 220px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card:hover { transform: scale(1.05); }
        .card img { width: 100%; border-radius: 5px; height: 150px; object-fit: contain; background: #eee; }
        .error { color: red; background: #ffe6e6; padding: 10px; border-radius: 5px; margin: 10px 0; }
        
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        #modal img { max-width: 90%; max-height: 90%; border-radius: 10px; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ“‘ Ø§Ø³Ú©Ù†Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§Ø³Ù†Ø§Ø¯ (Ù¾Ø±ÙˆÚ˜Ù‡ Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØµÙˆÛŒØ±)</h1>
        
        {% if error %}
            <div class="error">{{ error }}</div>
        {% endif %}

        <div style="background: #e9ecef; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
            <form method="POST" enctype="multipart/form-data" action="/">
                <input type="hidden" name="action" value="upload">
                <input type="file" name="image" accept="image/*" required style="margin-left: 10px;">
                <button type="submit" class="btn" style="background: #28a745;">ğŸ“¤ Ø¢Ù¾Ù„ÙˆØ¯ Ùˆ Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø²Ø´</button>
            </form>
        </div>

        {% if step == 2 %}
            <h2 style="border-bottom: 2px solid #ddd; padding-bottom: 10px; color: #007bff;">
                ğŸ” ØªØ­Ù„ÛŒÙ„ ØªØµÙˆÛŒØ± Ùˆ ØªØ´Ø®ÛŒØµ Ú©Ø§ØºØ°
            </h2>
            <p style="color: #666;">Ù…Ø±Ø§Ø­Ù„ Ø²ÛŒØ± Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø·ÛŒ Ø´Ø¯ ØªØ§ Ú©Ø§ØºØ° Ù¾ÛŒØ¯Ø§ Ø´ÙˆØ¯:</p>
            
            <div style="display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; justify-content: center;">
                
                <div class="card" onclick="openModal(this)">
                    <img src="{{ results.step2.gray_img }}">
                    <h4>Û±. Grayscale</h4>
                    <p style="font-size: 12px;">Ø­Ø°Ù Ø±Ù†Ú¯</p>
                </div>

                <div class="card" onclick="openModal(this)">
                    <img src="{{ results.step2.blur_img }}">
                    <h4>Û². Gaussian Blur</h4>
                    <p style="font-size: 12px;">Ø­Ø°Ù Ù†ÙˆÛŒØ² (11x11)</p>
                </div>

                <div class="card" onclick="openModal(this)">
                    <img src="{{ results.step2.edge_img }}">
                    <h4>Û³. Canny Edge</h4>
                    <p style="font-size: 12px;">Ù„Ø¨Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚ÙˆÛŒ</p>
                </div>

                <div class="card" style="border: 2px solid orange;" onclick="openModal(this)">
                    <img src="{{ results.step2.dilate_img }}">
                    <h4>Û´. Dilation</h4>
                    <p style="font-size: 12px;">Ø§ØªØµØ§Ù„ Ø®Ø·ÙˆØ·</p>
                </div>

                <div class="card" style="border: 3px solid #28a745;" onclick="openModal(this)">
                    <img src="{{ results.step2.contours_img }}">
                    <h3 style="color: green;">Ûµ. Ø®Ø±ÙˆØ¬ÛŒ</h3>
                    <p style="font-size: 12px;">{{ results.step2.status }}</p>
                </div>
            </div>

            <form method="POST" style="margin-top: 30px;">
                <input type="hidden" name="action" value="step3">
                <button class="btn" style="background: #007bff; font-size: 18px; padding: 12px 30px;">
                    âœ… ØªØ§ÛŒÛŒØ¯ Ùˆ Ø¨Ø±Ø´ ØªØµÙˆÛŒØ± (Crop)
                </button>
            </form>
        {% endif %}

        {% if step >= 3 %}
            <h2 style="border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-top: 30px; color: green;">
                âœ… Ø§Ø³Ú©Ù† ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯
            </h2>
            
            <div class="grid">
                <div class="card" style="width: 300px;" onclick="openModal(this)">
                    <img src="{{ results.step3_img }}">
                    <h3>Ø§ØµÙ„Ø§Ø­ Ù¾Ø±Ø³Ù¾Ú©ØªÛŒÙˆ</h3>
                </div>

                <div class="card" style="width: 300px; border: 2px solid #28a745;" onclick="openModal(this)">
                    <img src="{{ results.final_img }}">
                    <h3>Ø®Ø±ÙˆØ¬ÛŒ Ù†Ù‡Ø§ÛŒÛŒ</h3>
                </div>
            </div>

            <div style="background: #f1f3f5; padding: 20px; border-radius: 12px; margin-top: 25px;">
                <h3 style="margin-top: 0; color: #495057;">ğŸ¨ ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ù‡Ø§ÛŒÛŒ</h3>
                <form method="POST" style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <input type="hidden" name="action" value="update_final">
                    
                    <select name="filter" class="btn" style="background: white; color: #333; border: 1px solid #ced4da;">
                        <option value="bw" {% if sel_filter == 'bw' %}selected{% endif %}>Ø³ÛŒØ§Ù‡ Ùˆ Ø³ÙÛŒØ¯ (B&W)</option>
                        <option value="magic" {% if sel_filter == 'magic' %}selected{% endif %}>Ø±Ù†Ú¯ÛŒ Ø¬Ø§Ø¯ÙˆÛŒÛŒ (Magic)</option>
                        <option value="gray" {% if sel_filter == 'gray' %}selected{% endif %}>Ø®Ø§Ú©Ø³ØªØ±ÛŒ (Gray)</option>
                        <option value="original" {% if sel_filter == 'original' %}selected{% endif %}>Ø¨Ø¯ÙˆÙ† ÙÛŒÙ„ØªØ± (Original)</option>
                    </select>

                    <button type="submit" name="rotation" value="{{ (sel_rotation + 90) % 360 }}" class="btn" style="background: #ffc107; color: black;">
                        ğŸ”„ Ú†Ø±Ø®Ø´ Û¹Û°Â° (Ø§Ù„Ø§Ù†: {{ sel_rotation }}Â°)
                    </button>
                    
                    <button type="submit" name="rotation" value="{{ sel_rotation }}" class="btn" style="background: #17a2b8;">
                        âœ… Ø§Ø¹Ù…Ø§Ù„
                    </button>
                </form>
            </div>
            
            <div style="margin-top: 30px;">
                <a href="/static/uploads/final_scanned.jpg" download="Scanned_Doc.jpg">
                    <button class="btn" style="background: #28a745; padding: 15px 40px; font-size: 18px;">
                        ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ù†Ù‡Ø§ÛŒÛŒ
                    </button>
                </a>
                <br><br>
                <a href="/"><button class="btn" style="background: #6c757d;">ğŸ”„ Ø´Ø±ÙˆØ¹ Ø¯ÙˆØ¨Ø§Ø±Ù‡</button></a>
            </div>
        {% endif %}

    </div>

    <div id="modal" onclick="this.style.display='none'">
        <img id="modal-img" src="">
    </div>

    <script>
        function openModal(element) {
            const img = element.querySelector('img');
            const modal = document.getElementById('modal');
            const modalImg = document.getElementById('modal-img');
            modalImg.src = img.src;
            modal.style.display = 'flex';
        }
    </script>
</body>
</html>